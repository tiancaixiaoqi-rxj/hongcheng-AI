<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 设置视口，适应不同设备的屏幕宽度，并设置初始缩放比例 -->
    <title>鸿程 AI 助手</title>
    <!-- 网页标题 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- 引入 Vue.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入 Axios 库，用于发送 HTTP 请求 -->
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@5.9.55/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <!-- 引入 Material Design Icons 字体库 -->

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f0f8ff;
      }
      #app {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .header {
        text-align: center;
        padding: 20px 0;
        font-size: 28px;
        font-weight: bold;
        color: #4a4a4a;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .main-content {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
      }
      .chat-area {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
      }
      .messages-container {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 20px;
      }
      .toolbar {
        width: 60px;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 0;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
      }
      .toolbar button {
        margin-bottom: 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        color: #4a4a4a;
        transition: color 0.3s ease;
      }
      .toolbar button:hover {
        color: #4e54c8;
      }
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, #4e54c8, #8f94fb);
        margin-top: auto;
        cursor: pointer;
        overflow: hidden;
      }
      .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .input-area {
        background-color: #ffffff;
        padding: 20px;
        border-top: 1px solid #e0e0e0;
      }
      .input-box {
        position: relative;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        min-height: 90px;
      }
      .input-box textarea {
        width: 100%;
        border: none;
        resize: none;
        outline: none;
        font-size: 16px;
      }
      .input-box::before {
        position: absolute;
        top: 5px;
        left: 10px;
        font-size: 10px;
        color: #999;
      }
      .send-btn,
      .upload-btn {
        position: absolute;
        bottom: 10px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: #4e54c8;
        transition: all 0.3s ease;
      }
      .upload-btn {
        left: 10px;
        margin-bottom: 2px;
      }
      .send-btn {
        right: 10px;
      }
      .send-btn:hover,
      .upload-btn:hover {
        transform: scale(1.1);
      }
      .chart-type-select {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #ffffff;
        border: 1px solid #ddd;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
      }
      .message {
        display: flex;
        margin-bottom: 20px;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message-content {
        display: flex;
        flex-direction: column;
        max-width: 70%;
      }
      .message-bubble {
        display: flex;
        align-items: flex-start;
      }
      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        overflow: hidden;
      }
      .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .message-text {
        background-color: #ffffff;
        padding: 12px 16px;
        border-radius: 18px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        line-height: 1.4;
      }
      .user-message {
        flex-direction: row-reverse;
      }
      .user-message .message-content {
        align-items: flex-end;
      }
      .user-message .message-bubble {
        flex-direction: row-reverse;
      }
      .user-message .message-avatar {
        margin-right: 0;
        margin-left: 10px;
      }
      .user-message .message-text {
        background-color: #4e54c8;
        color: white;
      }
      .message-actions {
        display: flex;
        justify-content: flex-start;
        margin-top: 5px;
        margin-left: 70px;
      }
      .message-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #4a4a4a;
        margin-right: 10px;
        transition: color 0.3s ease;
      }
      .message-actions button:hover {
        color: #4e54c8;
      }
      .uploaded-files {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }
      .uploaded-file {
        display: flex;
        align-items: center;
        background-color: #f0f0f0;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 14px;
      }
      .uploaded-file .mdi {
        margin-right: 5px;
      }
      .uploaded-file .remove {
        margin-left: 5px;
        cursor: pointer;
        color: red;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">鸿程 AI</div>
      <div class="main-content">
        <div class="chat-area">
          <div class="messages-container">
            <div
              v-for="message in messages"
              :key="message.id"
              :class="['message', message.sender + '-message']"
            >
              <!-- 如果消息发送者是 ai，则显示对应的 AI 头像图片 -->
              <div class="message-content">
                <div class="message-bubble">
                  <div class="message-avatar">
                    <img
                      v-if="message.sender === 'ai'"
                      src="AI.svg"
                      alt="AI Avatar"
                    />
                    <!-- 否则显示一个用于代表用户的空白区域 -->
                    <div v-else class="user-avatar"></div>
                  </div>
                  <div v-if="message.hasChart" class="message-text">
                    <a :href="message.chartUrl" target="_blank">查看图表</a>
                  </div>
                  <div v-if="message.hasImage" class="message-text">
                    <img :src="message.imageUrl" alt="Image" />
                  </div>
                  <div class="message-text">{{ message.text }}</div>
                </div>
                <div v-if="message.sender === 'ai'" class="message-actions">
                  <!-- 好评按钮，点击调用 rateMessage 方法并传递消息 id 和 true -->
                  <button @click="rateMessage(message.id, true)" title="好评">
                    <span class="mdi mdi-thumb-up"></span>
                  </button>
                  <!-- 差评按钮，点击调用 rateMessage 方法并传递消息 id 和 false -->
                  <button @click="rateMessage(message.id, false)" title="差评">
                    <span class="mdi mdi-thumb-down"></span>
                  </button>
                  <!-- 如果消息有文本，显示复制按钮，点击调用 copyMessage 方法并传递消息文本 -->
                  <button
                    v-if="message.hasText"
                    @click="copyMessage(message.text)"
                    title="复制"
                  >
                    <span class="mdi mdi-content-copy"></span>
                  </button>
                  <!-- 如果消息有图表或图像，显示下载按钮，点击调用 downloadContent 方法并传递消息对象 -->
                  <button
                    v-if="message.hasChart || message.hasImage"
                    @click="downloadContent(message)"
                    title="下载"
                  >
                    <span class="mdi mdi-download"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- 遍历已上传文件数组，展示每个文件的信息 -->
          <div class="input-area">
            <div class="uploaded-files" v-if="uploadedFiles.length > 0">
              <div
                v-for="file in uploadedFiles"
                :key="file.name"
                class="uploaded-file"
              >
                <span class="mdi mdi-file-outline"></span>
                {{ file.name }}
                <span class="remove" @click="removeFile(file)">❌</span>
              </div>
            </div>
            <div class="input-box">
              <textarea
                v-model="userInput"
                placeholder="随时为您服务，帮您解决任何问题"
                @keydown.enter.prevent="sendMessage"
              ></textarea>
              <input
                type="file"
                ref="fileInput"
                style="display: none"
                @change="handleFileUpload"
                multiple
              />
              <!-- 上传按钮，点击触发 triggerFileUpload 方法，按钮标题为上传文件 -->
              <button
                class="upload-btn"
                @click="triggerFileUpload"
                title="上传文件"
              >
                <span class="mdi mdi-upload"></span>
              </button>
              <!-- 发送按钮，点击调用 sendMessage 方法，按钮标题为发送 -->
              <button class="send-btn" @click="sendMessage" title="发送">
                <span class="mdi mdi-send"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="toolbar">
          <!-- 新对话按钮，点击调用 newChat 方法，按钮标题为新对话 -->
          <button @click="newChat" title="新对话">
            <span class="mdi mdi-plus"></span>
          </button>
          <!-- 历史记录按钮，点击调用 showHistory 方法，按钮标题为历史记录 -->
          <button @click="showHistory" title="历史记录">
            <span class="mdi mdi-history"></span>
          </button>
          <div
            class="user-avatar"
            @click="changeUserAvatar"
            title="点击进行更换头像"
          ></div>
        </div>
      </div>
      <!-- 遍历图表类型数组，生成每个图表类型的选项 -->
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          userInput: "",
          messages: [
            {
              id: 1,
              sender: "ai",
              text: "Hi~ ，请问有什么可以帮助你的吗？",
              hasText: true,
              hasChart: false,
              hasImage: false,
              imageUrl: "",
              chartUrl: "",
            },
          ],
          uploadedFiles: [],
          userAvatarUrl: "",
        },
        methods: {
          //发送消息的方法

          sendMessage(event) {
            if (event && event.shiftKey) {
              return; // Allow Shift+Enter for new line
            }
            // 如果用户输入的内容不为空或者有上传的文件
            if (this.userInput.trim() || this.uploadedFiles.length > 0) {
              let messageText = this.userInput.trim();
              let formData = new FormData(); // 创建FormData对象来发送文件
              // 如果有上传的文件，添加到FormData中
              if (this.uploadedFiles.length > 0) {
                this.uploadedFiles.forEach((file) => {
                  formData.append("files", file); // 'files'是后端期望的文件字段名
                });
                messageText +=
                  " [附件: " +
                  this.uploadedFiles.map((f) => f.name).join(", ") +
                  "]";
              }
              this.messages.push({
                id: Date.now(),
                sender: "user",
                text: messageText,
              });
              this.userInput = "";
              this.uploadedFiles = [];

              formData.append("message", messageText); // 添加文本消息到表单数据中

              // 发起POST请求
              axios
                .post("http://your-backend-url/api/messages", formData)
                .then((response) => {
                  // 处理响应
                  const aiMessage = response.data;
                  console.log("Message sent successfully", response.data);

                  // 清空用户输入框和已上传文件数组


                  // 将 AI 的回复添加到消息数组中，并设置相应的属性
                  const message = {
                    id: aiMessage.id,
                    sender: "ai",
                    text: aiMessage.text,
                    hasText: aiMessage.hasText,
                    hasChart: aiMessage.hasChart,
                    hasImage: aiMessage.hasImage,
                  };
                  if (aiMessage.hasChart) {
                    this.messages.push({
                      chartUrl: aiMessage.chartUrl,
                    });
                  }
                  if (aiMessage.hasImage) {
                    this.messages.push({
                      imageUrl: aiMessage.imageUrl,
                    });
                  }

                  this.messages.push(message);
                })
                .catch((error) => {
                  // 处理错误
                  console.error("Error sending message:", error);
                });
            }
          },
          // 触发文件上传的方法，通过点击隐藏的文件输入框来实现
          triggerFileUpload() {
            this.$refs.fileInput.click();
          },
          // 处理文件上传的方法，将上传的文件添加到已上传文件数组中
          handleFileUpload(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
              this.uploadedFiles.push(files[i]);
            }
          },
          // 开始新聊天的方法，清空消息、用户输入、已上传文件和图表类型选择
          newChat() {
            this.messages = [
              {
                id: Date.now(),
                sender: "ai",
                text: "Hi~ ，请问有什么可以帮助你的吗？",
                hasText: true,
                hasChart: false,
                hasImage: false,
                imageUrl: "",
                chartUrl: "",
              },
            ];
            this.userInput = "";
            this.uploadedFiles = [];
          },
          // 显示聊天历史的方法
          showHistory() {
            console.log("Showing chat history");
          },
          // 给消息评分的方法，在控制台输出评分信息
          rateMessage(messageId, isPositive) {
            console.log(
              `Message ${messageId} rated ${
                isPositive ? "positively" : "negatively"
              }`
            );
          },
          // 复制消息文本的方法，将文本复制到剪贴板
          copyMessage(text) {
            navigator.clipboard
              .writeText(text)
              .then(() => {
                alert("文本已复制到剪贴板");
              })
              .catch((err) => {
                console.error("无法复制文本: ", err);
              });
          },
          // 下载消息内容（图表或图像）的方法，在控制台输出下载信息
          downloadContent(message) {
            if (message.hasChart) {
              console.log(`Downloading chart for message ${message.id}`);
            }
            if (message.hasImage) {
              console.log(`Downloading image for message ${message.id}`);
            }
          },
          // 更改用户头像的方法
          changeUserAvatar() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.onchange = (e) => {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  this.userAvatarUrl = e.target.result;
                };
                reader.readAsDataURL(file);
              }
            };
            input.click();
          },
          removeFile(file) {
            const index = this.uploadedFiles.indexOf(file);
            if (index > -1) {
              this.uploadedFiles.splice(index, 1);
            }
          },
        },
      });
    </script>
  </body>
</html>
